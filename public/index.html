<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minml dApp example</title>
    <script>
        var reefSigner;
        var dappApi;
        window.addEventListener('load', async ()=>{
            try {
                dappApi = await initMinDapp();
                const extension = await dappApi.getReefExtension('Minimal DApp Example');
                extension.accounts.subscribe(async (accounts) => {
                    if (!accounts.length) {
                        document.dispatchEvent(new CustomEvent('min-dapp_error', {detail: {message: 'Create or import account in extension.'}}))
                        return;
                    }
                    console.log("acounts=", accounts);
                    // const selectedSigner = await getSigner(extension, accounts[0]);
                    document.dispatchEvent(new CustomEvent('min-dapp_app-state', {
                        detail: {
                            state: {
                                extension,
                                accounts
                            }
                        }
                    }));
                });
            }catch (e) {
                displayError(e);
            }
        });

        function displayError(e) {
            document.body.classList.add("reef-extension-error");
            document.getElementsByClassName('error-msg')[0].innerHTML = e.message;
        }

        async function bindEvm(reefSigner) {
            try {
                document.body.classList.add("claiming-evm");
                await reefSigner.signer.claimDefaultAccount();
                document.body.classList.add("evm-connected");
            }catch (e) {
                displayError(e);
            }
        }

        document.addEventListener('min-dapp_initialized', () => document.body.classList.add("connected"));
        document.addEventListener('min-dapp_evm-connected', () => document.body.classList.add("evm-connected"));
        document.addEventListener('min-dapp_error', (ev) => displayError(ev.detail));
        document.addEventListener('min-dapp_app-state', async (ev) => {
            appState = ev.detail;
            try {
                reefSigner = await dappApi.getSigner(ev.detail.state.extension, ev.detail.state.accounts[0]);
            }catch (e){
                displayError(e);
                return;
            }
            if (await reefSigner.signer.isClaimed()) {
                document.dispatchEvent(new Event('min-dapp_evm-connected'))
            }
            document.body.classList.add("extension-initialized");
            document.dispatchEvent(new Event('min-dapp_initialized'))
        });
    </script>
    <script src="js/index.js"></script>

    <style>
        .content {
            display: none;
        }

        .extension-initialized.connected .content {
            display: block;
        }

        .extension-initialized .connecting {
            display: none;
        }

        .error-display {
            display: none;
        }

        .reef-extension-error .error-display {
            display: block;
        }

        .content {
            display: none;
        }

        code {
            background-color: #ECEFF1;
        }

        .evm-contract-calls {
            display: none;
        }

        .evm-connected .evm-contract-calls {
            display: block;
        }

        .evm-connected .bind-evm {
            display: none;
        }

        .binding-evm {
            display: none;
        }

        .claiming-evm .binding-evm {
            display: block;
        }

        .claiming-evm .bind-start {
            display: none;
        }
    </style>
</head>
<body>
<h3>Minml dApp</h3>
<div class="connecting">
    <p>Connecting to chain, please wait ...</p>
</div>
<div class="content">
    <div class="bind-evm">
        <div class="bind-start">
            <p>Click below to start calling EVM contracts</p>
            <button type="button" onclick="bindEvm(reefSigner)">Enable contract interaction</button>
        </div>
        <div class="binding-evm">
            <p>Transaction in progress ...</p>
        </div>
    </div>
    <div class="evm-contract-calls">
        <button type="button" onclick="dappApi.getFlipperValue(reefSigner.signer)">log contract value</button>
        <button type="button" onclick="dappApi.flipIt(reefSigner.signer)">toggle contract value</button>
    </div>
</div>
<div class="error-display">
    <h3>ERROR</h3>
    <div class="error-msg"></div>
</div>
</body>
</html>
