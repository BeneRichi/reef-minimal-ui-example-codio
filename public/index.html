<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minml dApp example</title>
    <script>
        var signer;
        var dappApi;
        window.addEventListener('load', async ()=>{
            try {
                dappApi = await getMnmlDappAPI();
                const extension = await dappApi.getReefExtension('Minimal DApp Example');

                dappApi.subscribeSigner(extension, (sigObj)=> {
                        console.log("got signer=",sigObj);
                    try{
                        setReefSigner(sigObj.signer)
                    }catch (err){
                        displayError(err);
                    }
                },
                displayError)
                /*extension.accounts.subscribe(async (accounts) => {
                    if (!accounts.length) {
                        displayError({ message: 'Create or import account in extension.' });
                        return;
                    }
                    console.log("acounts=", accounts);
                    const rSigner = getReefSignerFromAccs({ extension, accounts });
                    setReefSigner(rSigner.signer);
                });*/
            }catch (e) {
                displayError(e);
            }
        });

        function displayError(e) {
            document.body.classList.add("reef-extension-error");
            document.getElementsByClassName('error-msg')[0].innerHTML = e.message;
        }

        async function bindEvm(sig) {
            try {
                document.body.classList.add("claiming-evm");
                await sig.claimDefaultAccount();
                document.body.classList.add("evm-connected");
            }catch (e) {
                displayError(e);
            }
        }

        async function getContractValue (sig) {
            var ctrRes = await dappApi.getFlipperValue(sig);
            console.log("vvv=",ctrRes);
            document.getElementsByClassName('contract-value')[0].innerHTML = ctrRes;
        }

        async function toggleContractValue (sig) {
            var ctrRes = await dappApi.flipIt(sig);
            console.log("flipped=",ctrRes);
            document.getElementsByClassName('contract-value')[0].innerHTML = ctrRes;
        }

        async function getReefSignerFromAccs ({ extension, accounts }) {
            let sig;
            try {
                sig = await dappApi.getSigner(extension, accounts[0]);
            }catch (e){
                displayError(e);
                return;
            }
            return sig;
        }
        async function setReefSigner (sig) {
            signer = sig;
            console.log("ssss=",signer);
            if (await signer.isClaimed()) {
                document.body.classList.add("evm-connected")
            }
            document.body.classList.add("extension-initialized");
            document.body.classList.add("connected")
        }
    </script>
    <script src="js/index.js"></script>

    <style>
        .content {
            display: none;
        }

        .extension-initialized.connected .content {
            display: block;
        }

        .extension-initialized .connecting {
            display: none;
        }

        .error-display {
            display: none;
        }

        .reef-extension-error .error-display {
            display: block;
        }

        .content {
            display: none;
        }

        code {
            background-color: #ECEFF1;
        }

        .evm-contract-calls {
            display: none;
        }

        .evm-connected .evm-contract-calls {
            display: block;
        }

        .evm-connected .bind-evm {
            display: none;
        }

        .binding-evm {
            display: none;
        }

        .claiming-evm .binding-evm {
            display: block;
        }

        .claiming-evm .bind-start {
            display: none;
        }
    </style>
</head>
<body>
<h3>Minml dApp</h3>
<div class="connecting">
    <p>Connecting to chain, please wait ...</p>
</div>
<div class="content">
    <div class="bind-evm">
        <div class="bind-start">
            <p>Click below to start calling EVM contracts</p>
            <button type="button" onclick="bindEvm(signer)">Enable contract interaction</button>
        </div>
        <div class="binding-evm">
            <p>Transaction in progress ...</p>
        </div>
    </div>
    <div class="evm-contract-calls">
        <div>
            <p>Contract value:</p>
            <h3 class="contract-value"></h3>
        </div>
        <button type="button" onclick="getContractValue(signer)">get contract value</button>
        <button type="button" onclick="toggleContractValue(signer)">toggle contract value</button>
    </div>
</div>
<div class="error-display">
    <h3>ERROR</h3>
    <div class="error-msg"></div>
</div>
</body>
</html>
