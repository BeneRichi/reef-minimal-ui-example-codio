<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minml dApp example</title>
    <script>
        var appState = {
            selectedSigner: undefined,
        }
        function displayError(e) {
            document.body.classList.add("reef-extension-error");
            document.getElementsByClassName('error-msg')[0].innerHTML = e.message;
        }

        document.addEventListener('min-dapp_initialized', () => document.body.classList.add("connected"));
        document.addEventListener('min-dapp_evm-connected', () => document.body.classList.add("evm-connected"));
        document.addEventListener('min-dapp_error', (ev) => displayError(ev.detail));
        document.addEventListener('min-dapp_app-state', async (ev) => {
            appState = ev.detail;
            appState.selectedSigner = await ev.detail.api.getSigner(ev.detail.state.extension, ev.detail.state.accounts[0]);
            if (await appState.selectedSigner.signer.isClaimed()) {
                document.dispatchEvent(new Event('min-dapp_evm-connected'))
            }
            document.body.classList.add("extension-initialized");
            document.dispatchEvent(new Event('min-dapp_initialized'))
        });
    </script>
    <script src="js/index.js"></script>

    <script>

        async function bindEvm() {
            try {
                document.body.classList.add("claiming-evm");
                await appState.selectedSigner.claimDefaultAccount();
                document.body.classList.add("evm-connected");
            }catch (e) {
                displayError(e);
            }
        }

    </script>
    <style>
        .content {
            display: none;
        }

        .extension-initialized.connected .content {
            display: block;
        }

        .extension-initialized .connecting {
            display: none;
        }

        .error-display {
            display: none;
        }

        .reef-extension-error .error-display {
            display: block;
        }

        .content {
            display: none;
        }

        code {
            background-color: #ECEFF1;
        }

        .evm-contract-calls {
            display: none;
        }

        .evm-connected .evm-contract-calls {
            display: block;
        }

        .evm-connected .bind-evm {
            display: none;
        }

        .binding-evm {
            display: none;
        }

        .claiming-evm .binding-evm {
            display: block;
        }

        .claiming-evm .bind-start {
            display: none;
        }
    </style>
</head>
<body>
<h3>Minml dApp</h3>
<div class="connecting">
    <p>Connecting to chain, please wait ...</p>
</div>
<div class="content">
    <div class="bind-evm">
        <div class="bind-start">
            <p>Click below to start calling EVM contracts</p>
            <button type="button" onclick="bindEvm()">Enable contract interaction</button>
        </div>
        <div class="binding-evm">
            <p>Transaction in progress ...</p>
        </div>
    </div>
    <div class="evm-contract-calls">
        <button type="button" onclick="appState.api.getFlipperValue(appState.selectedSigner)">log contract value</button>
        <button type="button" onclick="appState.api.flipIt(appState.selectedSigner)">toggle contract value</button>
    </div>
</div>
<div class="error-display">
    <h3>ERROR</h3>
    <div class="error-msg"></div>
</div>
</body>
</html>
